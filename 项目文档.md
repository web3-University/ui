# Web3 University 项目文档

## 项目概述

Web3 University 是一个基于区块链的去中心化在线教育平台，采用 Monorepo 架构，提供课程交易、学习管理、DAO 治理等功能。

**技术栈**：
- 前端框架：Next.js 15.5.4 (React 19.1.0)
- 样式：Tailwind CSS 4
- Web3 集成：wagmi 2.17.5, viem 2.37.8, RainbowKit 2.2.8
- 状态管理：Zustand 5.0.8
- 数据请求：@tanstack/react-query 5.90.2, axios 1.12.2
- 包管理：pnpm (workspace)
- 构建工具：Rollup, Turbopack
- 测试：Jest, Cypress
- 代码规范：Biome, husky, lint-staged

---

## 项目结构

```
front/
├── apps/                       # 应用层
│   ├── web/                   # 主 Web 应用 (Next.js)
│   │   ├── src/
│   │   │   ├── app/          # Next.js App Router 页面
│   │   │   │   ├── home/     # 首页
│   │   │   │   ├── market/   # 课程市场
│   │   │   │   ├── learn/    # 学习中心
│   │   │   │   ├── dao/      # DAO 治理
│   │   │   │   └── course-create/ # 创建课程
│   │   │   ├── components/   # 业务组件
│   │   │   ├── lib/          # 业务逻辑库
│   │   │   │   ├── api/      # API 调用
│   │   │   │   ├── dao/      # DAO 相关逻辑
│   │   │   │   └── web3/     # Web3 配置
│   │   │   ├── types/        # 类型定义
│   │   │   ├── hooks/        # 自定义 hooks
│   │   │   └── config/       # 配置文件
│   │   └── package.json
│   └── storybook/            # UI 组件开发环境
│
├── packages/                  # 共享包
│   ├── ui/                   # 通用 UI 组件库
│   │   ├── src/
│   │   │   ├── Button/
│   │   │   └── CourseCard/
│   ├── hooks/                # 通用 React Hooks
│   │   ├── useDebounce.ts
│   │   ├── useLocalStorage.ts
│   │   ├── useImmer.ts
│   │   ├── usePrevious.ts
│   │   └── useWindowSize.ts
│   ├── libs/                 # 通用工具库
│   └── uni-wallet-lib/       # 钱包集成库 (核心)
│       ├── src/
│       │   ├── hooks/
│       │   │   ├── wallet/   # 钱包 hooks
│       │   │   │   ├── useWalletAuth.ts
│       │   │   │   ├── useWalletSign.ts
│       │   │   │   ├── useWalletConnection.ts
│       │   │   │   ├── useWalletInfo.ts
│       │   │   │   └── useNetworkSwitch.ts
│       │   │   └── contract/ # 智能合约 hooks
│       │   │       ├── useCourseContract.ts
│       │   │       ├── useSimpleYDToken.ts
│       │   │       ├── useERC20.ts
│       │   │       ├── useContractRead.ts
│       │   │       ├── useContractWrite.ts
│       │   │       └── contractFactory.ts
│       │   ├── components/   # 钱包 UI 组件
│       │   │   └── WalletButton/
│       │   ├── providers/    # 钱包 Provider
│       │   ├── config/       # 链配置
│       │   ├── types/        # 类型定义
│       │   └── contract/     # 合约 ABI
│
├── package.json              # 根配置
├── pnpm-workspace.yaml       # Workspace 配置
├── lerna.json                # Lerna 配置
├── biome.json                # 代码规范配置
└── tsconfig.json             # TypeScript 配置
```

---

## 核心功能

### 1. 首页 (`/home`)
- 展示热门课程
- 平台数据统计
- 快速导航

### 2. 课程市场 (`/market`)
- 浏览所有已发布课程
- 课程搜索和筛选
- 课程详情查看
- 使用代币购买课程

### 3. 学习中心 (`/learn`)
- 查看已购买的课程
- 学习进度跟踪
- 课程内容访问
- 学习进度更新

### 4. DAO 治理 (`/dao`)
- 查看治理提案列表（active、passed、rejected）
- 提案详情展示
- 投票功能（需要持有治理代币）
- 提案分类：课程规则、奖励分配、NFT规则、平台规则、定价规则

### 5. 创建课程 (`/course-create`)
- 讲师创建新课程
- 设置课程信息（标题、价格、课时等）
- 发布/取消发布课程
- 更新课程信息

### 6. 钱包集成
- 多钱包支持（通过 RainbowKit）
- 钱包连接/断开
- 网络切换
- 签名认证（SIWE - Sign-In with Ethereum）
- 钱包信息展示

### 7. 智能合约交互

#### 课程合约 (CourseContract)
- **地址**: `0x0a42F4f8Cb23460BDeD2e18475920Bdb6df5641d`
- **功能**:
  - 创建课程
  - 购买课程
  - 更新课程价格
  - 更新学习进度
  - 请求退款
  - 查询课程信息
  - 查询学生课程列表
  - 查询讲师课程列表
  - 批量检查访问权限
  - 讲师认证管理

#### ERC20 代币合约 (YD Token)
- 代币余额查询
- 代币授权
- 代币转账

---

## 启动项目

### 1. 环境要求

- Node.js: >= 18.0.0
- pnpm: 10.17.1
- Git

### 2. 安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd front

# 安装依赖
pnpm install
```

### 3. 环境变量配置

在 `apps/web` 目录下创建 `.env.local` 文件：

```env
# 后端 API 地址
NEXT_PUBLIC_API_BASE_URL=http://your-backend-api.com/api/v1

# 钱包连接配置
NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID=your_project_id

# 智能合约地址
NEXT_PUBLIC_COURSE_CONTRACT_ADDRESS=0x0a42F4f8Cb23460BDeD2e18475920Bdb6df5641d
NEXT_PUBLIC_TOKEN_CONTRACT_ADDRESS=your_token_address

# 链配置（根据使用的区块链网络）
NEXT_PUBLIC_CHAIN_ID=1  # 1: Ethereum Mainnet, 11155111: Sepolia Testnet
```

### 4. 启动开发服务器

```bash
# 只启动主应用
pnpm dev

# 或启动所有应用和包（并行）
pnpm dev:all

# 单独启动 Storybook (UI 组件开发)
pnpm dev:storybook
```

访问 http://localhost:3000 查看应用

### 5. 构建生产版本

```bash
# 构建所有包
pnpm build:packages

# 构建主应用
pnpm build

# 或一键构建（包含 packages 和 web）
pnpm build
```

### 6. 启动生产服务器

```bash
pnpm start
```

---

## 后端接口调用

### HTTP 客户端配置

位置：`apps/web/src/lib/http.ts`

```typescript
http<T>(path: string, options?: HttpOptions): Promise<T>
```

**配置项**:
- `method`: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH'
- `token`: JWT Token（可选）
- `body`: 请求体（自动转 JSON）
- `headers`: 自定义 headers
- `nextOptions`: Next.js fetch 选项（如 cache, revalidate）

### API 接口列表

#### 1. 课程相关 (`apps/web/src/lib/api/home.ts`)

```typescript
// 获取课程列表
GET /courses/list
返回: Course[]

// 获取课程详情
GET /courses/detailCourse?courseId={courseId}
返回: CourseDetail

// 获取热门课程
GET /courses/popular
返回: Course[]

// 购买课程（链上交易后调用）
POST /users/purchaseCourse
Body: {
  walletAddress: string;
  courseId: number;
  transactionHash: string;
  amount: string;
}
```

#### 2. 认证相关

```typescript
// 请求签名 nonce
POST /api/v1/auth/nonce
Body: { walletAddress: string }
返回: { nonce: string }

// 验证签名，获取 JWT Token
POST /api/v1/auth/verify
Body: {
  walletAddress: string;
  signature: string;
  message: string;
}
返回: {
  accessToken: string;
  refreshToken: string;
  user: UserInfo;
  tokenType: string;
  expiresIn: number;
}
```

#### 3. DAO 治理相关 (`apps/web/src/lib/api/proposals.ts`)

```typescript
// 获取提案列表
GET /dao/proposals
返回: ProposalsByStatus

// 获取提案详情
GET /dao/proposals/{proposalId}
返回: Proposal

// 投票
POST /dao/proposals/{proposalId}/vote
Body: {
  walletAddress: string;
  choice: 'for' | 'against';
  votingPower: number;
}
```

### 使用示例

```typescript
import { http } from '@/lib/http';

// GET 请求
const courses = await http<Course[]>('/courses/list');

// POST 请求（带认证）
const token = localStorage.getItem('AUTH_TOKEN');
const result = await http('/users/purchaseCourse', {
  method: 'POST',
  token,
  body: {
    walletAddress: '0x...',
    courseId: 1,
    transactionHash: '0x...',
    amount: '100'
  }
});

// 使用 Next.js 缓存
const courses = await http<Course[]>('/courses/list', {
  nextOptions: {
    next: { revalidate: 60 } // 60秒重新验证
  }
});
```

---

## 智能合约交互

### 使用 useCourseContract Hook

```typescript
import { useCourseContract } from '@web3-university/uni-wallet-lib';

function MyComponent() {
  const {
    // 查询方法
    getCourse,
    hasAccess,
    getStudentCourses,
    getTotalCourses,

    // 写入方法
    purchaseCourse,
    createCourse,
    updateCourseProgress,

    // 交易回执
    purchaseCourseReceipt,
  } = useCourseContract({
    address: '0x0a42F4f8Cb23460BDeD2e18475920Bdb6df5641d',
    tokenDecimals: 18
  });

  // 查询课程
  const { data: course, isLoading } = getCourse(1n);

  // 购买课程
  const handlePurchase = async () => {
    try {
      const result = await purchaseCourse(1n);
      console.log('Transaction hash:', result.hash);
    } catch (error) {
      console.error('Purchase failed:', error);
    }
  };

  // 监听交易状态
  useEffect(() => {
    if (purchaseCourseReceipt.isSuccess) {
      console.log('Purchase confirmed!');
      // 调用后端 API 记录购买
      await http('/users/purchaseCourse', {
        method: 'POST',
        body: {
          walletAddress: address,
          courseId: 1,
          transactionHash: purchaseCourseReceipt.data.transactionHash,
          amount: course.price.toString()
        }
      });
    }
  }, [purchaseCourseReceipt.isSuccess]);

  return (
    <div>
      {course && <h1>{course.title}</h1>}
      <button onClick={handlePurchase}>购买课程</button>
    </div>
  );
}
```

### 使用钱包认证

```typescript
import { useWalletAuth } from '@web3-university/uni-wallet-lib';

function LoginButton() {
  const {
    isAuthenticating,
    isAuthenticated,
    error,
    signIn,
    signOut
  } = useWalletAuth({
    domain: 'https://your-domain.com',
    apiBaseUrl: '/api/v1/auth/nonce',
    onSuccess: (token) => {
      console.log('登录成功:', token);
      // 跳转到需要认证的页面
    },
    onError: (error) => {
      console.error('登录失败:', error);
    }
  });

  return (
    <div>
      {!isAuthenticated ? (
        <button onClick={signIn} disabled={isAuthenticating}>
          {isAuthenticating ? '登录中...' : '钱包登录'}
        </button>
      ) : (
        <button onClick={signOut}>退出登录</button>
      )}
      {error && <p>错误: {error}</p>}
    </div>
  );
}
```

---

## 开发工具

### 代码规范

```bash
# 检查代码
pnpm lint

# 格式化代码
pnpm format

# 类型检查
pnpm type-check
```

### 测试

```bash
# 单元测试
pnpm test:unit

# E2E 测试
pnpm test:e2e

# CI 环境测试
pnpm test:unit:ci
pnpm test:e2e:ci
```

### Git 提交

项目使用 husky + lint-staged 进行 Git hooks 管理：

```bash
# 提交前会自动：
# 1. 格式化代码 (biome format)
# 2. 检查代码规范 (biome check)
# 3. 运行类型检查

git add .
git commit -m "feat: 添加新功能"
```

### 发布包

```bash
# 清理构建产物
pnpm clean:packages

# 构建所有包
pnpm build:packages

# 发布到 npm registry
pnpm publish:packages

# 发布 libs 到私有源
pnpm publish:libs
```

---

## 路由配置

位置：`apps/web/src/config/routes.ts`

```typescript
export const MAIN_ROUTES = [
  { label: '首页', href: '/home', aliases: ['/'] },
  { label: '课程市场', href: '/market' },
  { label: '学习中心', href: '/learn' },
  { label: 'DAO治理', href: '/dao', requiresAuth: true },
];
```

---

## 技术亮点

1. **Monorepo 架构**：使用 pnpm workspace + lerna 管理多包，提高代码复用性
2. **类型安全**：全面使用 TypeScript，包括智能合约交互
3. **Web3 集成**：基于 wagmi + viem 的现代 Web3 开发栈
4. **性能优化**：
   - Next.js 15 + Turbopack 极速构建
   - React 19 Compiler 优化
   - 预取管理器 (PrefetchManager)
5. **可测试性**：Jest + Cypress 完整测试覆盖
6. **开发体验**：Biome 统一代码风格，Storybook 组件开发

---

## 常见问题

### 1. 钱包连接失败
- 检查是否安装了钱包插件（如 MetaMask）
- 确认网络配置正确
- 查看浏览器控制台错误信息

### 2. 交易失败
- 确认钱包有足够的 gas 费
- 检查代币授权是否完成
- 查看合约交互参数是否正确

### 3. 后端 API 调用失败
- 检查 `.env.local` 中的 `NEXT_PUBLIC_API_BASE_URL` 配置
- 确认后端服务正常运行
- 查看网络请求响应状态码和错误信息

### 4. 构建失败
```bash
# 清理依赖重新安装
rm -rf node_modules
rm pnpm-lock.yaml
pnpm install

# 清理 Next.js 缓存
rm -rf apps/web/.next
pnpm build
```

---

## 贡献指南

1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/amazing-feature`)
3. 提交更改 (`git commit -m 'feat: add amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 提交 Pull Request

---

## 许可证

[根据实际情况添加]

---

## 联系方式

[根据实际情况添加]
